name: Build & Release

on:
  push:
    tags:
      - '**'
  pull_request:
    branches:
      - '**'

concurrency:
  # SHA is added to the end if on `main` to let all main workflows run
  group: ${{ github.ref }}-${{ github.workflow }}-${{ github.event_name }}-${{ github.ref == 'refs/heads/main' && github.sha || '' }}
  cancel-in-progress: true

jobs:
  build:
    name: Build binaries
    runs-on: ${{ matrix.runs-on }}
    defaults:
      run:
        shell: bash
    strategy:
      fail-fast: false
      matrix:
        runs-on: [ ubuntu-latest, windows-2019 ]
        platform: [ amd64 ]
        config:
          - app-name: climate-tokenization-chia
            app-mode: registry
            app-description: "Carbon tokenization engine on the Chia blockchain"
          - app-name: climate-explorer-chia
            app-mode: explorer
            app-description: "Interface for viewing Chia on-chain carbon tokens"
          - app-name: dev-token-driver-chia
            app-mode: dev
            app-description: "Token driver in dev mode"

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          submodules: 'recursive'

      - name: Setup Python
        #uses: Chia-Network/actions/setup-python@main
        uses: actions/setup-python@v4
        with:
          python-version: '3.10.8'

      - name: Create .env file
        run: |
          echo "MODE=${{ matrix.config.app-mode }}" > .env
          echo 'CHIA_ROOT="~/.chia/mainnet"' >> .env
          echo 'CONFIG_PATH="climate_token/config/config.yaml"' >> .env

      - name: Install with poetry and package application (Linux)
        run: |
          pip install virtualenv
          python -m virtualenv venv
          source venv/bin/activate
          pip install pyinstaller
          pip install poetry
          poetry install
          python -m PyInstaller --clean pyinstaller.spec
        if: matrix.runs-on != 'windows-2019'

      - name: Install with poetry and package application (Windows)
        run: |
          echo "~~~~~ Clear pip cache ~~~~~"
          pip cache purge
          echo "~~~~~ Pip installing virtualenv ~~~~~"
          pip install virtualenv --no-cache-dir
          echo "~~~~~ Creating the virtualenv ~~~~~"
          python -m virtualenv venv
          "echo ~~~~~ Activating the virtualenv ~~~~~"
          .\venv\Scripts\activate
          echo "~~~~~ Update PIP and related packages ~~~~~"
          pip install --upgrade pip setuptools wheel --no-cache-dir
          echo "~~~~~ Installing pyinstaller with pip ~~~~~"
          pip install pyinstaller --no-cache-dir
          echo "~~~~~ Installing Poetry ~~~~~"
          (Invoke-WebRequest -Uri https://install.python-poetry.org -UseBasicParsing).Content | py -
          echo "~~~~~ Running poetry install"
          C:\Users\runneradmin\AppData\Roaming\Python\Scripts\poetry install
          echo "~~~~~ Running PyInstaller ~~~~~"
          python -m PyInstaller --clean pyinstaller.spec
        if: matrix.runs-on == 'windows-2019'

      - name: Get tag name
        id: tag-name
        run: |
          TAGNAME=$(echo $GITHUB_REF | cut -d / -f 3)
          echo "TAGNAME=${TAGNAME}" >> $GITHUB_OUTPUT
          echo "Tag is ${TAGNAME}"
          echo "github.sha is ${{ github.sha }}"

      - name: Install j2
        run: |
          pip install j2cli

      - name: Rename Windows exe file
        run: |
          mv ./dist/main.exe ./dist/${{ matrix.config.app-name }}_${{ steps.tag-name.outputs.TAGNAME || github.sha }}_${{ matrix.platform }}.exe
        if: matrix.runs-on == 'windows-2019'

      # Windows Code Signing
      - name: Decode code signing cert into an encrypted file
        uses: kitek/decode-base64-into-file-action@1.0
        with:
          encoded-value: ${{ secrets.WIN_CODE_SIGN_CERT }}
          destination-file: .\win_code_sign_cert.pfx
        if: matrix.runs-on == 'windows-2019'


      - name: Sign windows artifacts
        uses: chia-network/actions/sign/windows@main
        with:
          certificate_path: .\win_code_sign_cert.pfx
          certificate_password: ${{ secrets.WIN_CODE_SIGN_PASSWORD }}
          file: ./dist/${{ matrix.config.app-name }}_${{ steps.tag-name.outputs.TAGNAME || github.sha }}_${{ matrix.platform }}.exe
        if: matrix.runs-on == 'windows-2019'

      - name: Create .deb Package
        env:
          APP_NAME: ${{ matrix.config.app-name }}
          APP_VERSION: ${{ steps.tag-name.outputs.TAGNAME }}
          PLATFORM: ${{ matrix.platform }}
          APP_DESCRIPTION: ${{ matrix.config.app-description }}
        run: |
          DEB_BASE="${{ matrix.config.app-name }}_${{ steps.tag-name.outputs.TAGNAME || github.sha }}-1_${{ matrix.platform }}"
          mkdir -p deb/$DEB_BASE/usr/local/bin
          cp dist/main deb/$DEB_BASE/usr/local/bin/${{ matrix.config.app-name }}
          chmod +x deb/$DEB_BASE/usr/local/bin/${{ matrix.config.app-name }}
          mkdir -p deb/$DEB_BASE/DEBIAN
          j2 -o "deb/$DEB_BASE/DEBIAN/control" build-scripts/deb/control.j2
          dpkg-deb --build --root-owner-group "deb/$DEB_BASE"
        if: matrix.runs-on == 'ubuntu-latest'

      - name: Upload deb
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.config.app-name }}_${{ steps.tag-name.outputs.TAGNAME || github.sha }}-1_${{ matrix.platform }}.deb
          path: ${{ github.workspace }}/deb/*.deb
          if-no-files-found: error
        if: matrix.runs-on == 'ubuntu-latest'

      - name: Upload exe
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.config.app-name }}_windows_${{ matrix.platform }}
          path: ${{ github.workspace }}/dist/*.exe
          if-no-files-found: error
        if: matrix.runs-on == 'windows-2019'
